---
typora-root-url: images
---

# 1 简介

平稳发布微服务：依次替换每个节点为最新的代码（也可以是1/2或1/3的节点）。

![1545646944584](/1545646944584.png)

其中：

- 关闭服务的命令，需要通知运维。直接“kill -9”，linux直接杀死了服务的进程，代码监听不到服务关闭的事件
- consul提供了移除节点的接口，可以直接调用。不需要等待health的心跳检测
- spring-boot-actuator与undertow都提供了关闭服务的接口，直接调用即可

## 1.1 负载均衡

跟服务发布相关的技术/工具：consul + feign + ribbon + spring-retry

- 微服务的集群，每个节点都有多个。多个节点之间通过consul实现服务的注册与发现
- 服务之间使用feign互相调用restful API
- feign通过ribbon将请求发送给具体的服务节点
- ribbon通过consul，获取服务列表，且，通过负载均衡算法，将请求路由给具体的服务节点
- 如果调用失败，使用spring-retry重试

很遗憾，consul没有提供负载均衡的功能，而ribbon分散在每一个服务节点上，只能通过心跳检测，移除本地缓存的“失效节点”。而且，默认会使用spring-retry重试

![1545621650805](/1545621650805.png)

将请求“路由”到某一个操作单元上。

